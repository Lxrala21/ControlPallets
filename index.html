<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Pallets</title>
    <link rel="stylesheet" href="styles.css">
    <script>
        let _authDone = false, _domDone = false;

        window.authReady = (async function checkSession() {
            try {
                const res = await fetch('http://192.168.80.103:8089/api.php?action=checkAuth', { credentials: 'include' });
                if (!res.ok) { window.location.href = 'login.html'; return; }
                const data = await res.json();
                if (!data.authenticated) { window.location.href = 'login.html'; return; }
                window.currentUser = data.user;
                window.currentRole = data.role;
                _authDone = true;
                if (_domDone) _applyRoleUI();
            } catch(e) { window.location.href = 'login.html'; }
        })();

        function _applyRoleUI() {
            const isAdmin = window.currentRole === 'admin';
            const roleLabel = isAdmin ? 'Administrador' : 'Operador';
            const infoEl = document.getElementById('userInfoText');
            if (infoEl) infoEl.textContent = '\uD83D\uDC64 ' + window.currentUser + ' (' + roleLabel + ')';
            if (!isAdmin) {
                const clearBtn = document.getElementById('clearAllBtn');
                if (clearBtn) clearBtn.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            _domDone = true;
            if (_authDone) _applyRoleUI();
        });
    </script>
</head>
<body>
    <div class="container">
        <header style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
            <h1>üì¶ Sistema de Control de Pallets</h1>
            <div id="userInfoBar" style="display: flex; align-items: center; gap: 12px; font-size: 0.8125rem;">
                <span id="userInfoText" style="color: var(--text-secondary);"></span>
                <button onclick="doLogout()" style="
                    padding: 5px 14px; border: 1px solid var(--border-color);
                    border-radius: 3px; background: #fff; cursor: pointer;
                    font-size: 0.8125rem; font-weight: 600; color: #c0392b;">
                    Cerrar Sesi√≥n
                </button>
            </div>
        </header>

        <!-- Barra de filtro por mes -->
        <div id="monthFilterBar" style="
            display: flex; align-items: center; gap: 12px;
            background: linear-gradient(135deg, #1F3864 0%, #2E75B6 100%);
            padding: 10px 16px; border-radius: 4px; margin-bottom: 8px;
            flex-wrap: wrap;
        ">
            <span style="color: #fff; font-size: 0.8125rem; font-weight: 600; white-space: nowrap; opacity: 0.85;">
                üìÖ Periodo:
            </span>
            <select id="monthSelector" onchange="onMonthChange(this.value)" style="
                padding: 5px 10px; border: none; border-radius: 3px;
                font-size: 0.8125rem; font-weight: 600;
                background: rgba(255,255,255,0.95); color: #1F3864;
                cursor: pointer; min-width: 180px;
            ">
                <option value="">Todos los meses</option>
            </select>
            <span id="monthSummaryBadge" style="
                color: #fff; font-size: 0.75rem; padding: 3px 10px;
                border-radius: 12px; background: rgba(255,255,255,0.15);
                white-space: nowrap;
            ">‚Äî</span>
        </div>

        <!-- Navigation Tabs -->
        <nav class="tabs" style="display: flex; align-items: center; flex-wrap: wrap; gap: 4px;">
            <button class="tab-button active" data-tab="registro">
                üìù Registro de Pallets
            </button>
            <button class="tab-button" data-tab="dashboard">
                üìä Dashboard
            </button>
            <button class="tab-button" data-tab="duplicados">
                üîÑ Duplicados
            </button>
            <button class="tab-button" data-tab="configuracion">
                ‚öôÔ∏è Configuraci√≥n
            </button>
            <a id="adminBinsLink" href="bins-admin.html" style="text-decoration: none;">
                <button class="tab-button" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    üóÑÔ∏è Admin BINs
                </button>
            </a>
            <button onclick="exportDashboardToExcel()" class="tab-button" style="margin-left: auto; background: linear-gradient(135deg, #1F3864 0%, #2E75B6 100%); color: white; font-weight: 600; white-space: nowrap;">
                üì• Exportar Dashboard Excel
            </button>
        </nav>

        <!-- Registro Tab -->
        <div id="registro" class="tab-content active">
            <div class="card">
                <h2>Registrar Nuevo Pallet</h2>
                <form id="palletForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="palletId">Pallet ID *</label>
                            <input type="text" id="palletId" required placeholder="Ej: PLT-001">
                        </div>

                        <div class="form-group">
                            <label for="piezas">Piezas *</label>
                            <input type="text" id="piezas" required placeholder="Nombre de las piezas">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="condicion">Condici√≥n *</label>
                            <input type="text" id="condicion" required placeholder="Ej: Bueno, Da√±ado, etc.">
                        </div>

                        <div class="form-group">
                            <label for="area">√Årea *</label>
                            <input type="text" id="area" required placeholder="Ej: Almac√©n, Producci√≥n">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="fecha">Fecha *</label>
                            <input type="date" id="fecha" required>
                        </div>

                        <div class="form-group">
                            <label for="turno">Turno *</label>
                            <select id="turno" required>
                                <option value="">Seleccione un turno</option>
                                <option value="Dia">Dia</option>
                                <option value="Noche">Noche</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="ubicacion">Ubicaci√≥n *</label>
                            <select id="ubicacion" required>
                                <option value="">Seleccione una ubicaci√≥n</option>
                            </select>
                            <button type="button" class="btn-add-ubicacion" onclick="openQuickUbicacionModal()">
                                + Nueva Ubicaci√≥n
                            </button>
                        </div>

                        <div class="form-group">
                            <label for="qty">QTY *</label>
                            <input type="number" id="qty" required min="1" placeholder="Cantidad">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Registrar Pallet</button>
                </form>
            </div>

            <div class="card">
                <h2>Lista de Pallets Registrados</h2>
                <div class="table-controls">
                    <input type="text" id="searchInput" placeholder="üîç Buscar por ID, piezas, ubicaci√≥n...">
                    <button id="clearAllBtn" class="btn btn-danger">Limpiar Todo</button>
                </div>

                <!-- Filtros Avanzados -->
                <div style="margin: 16px 0; padding: 16px; background-color: var(--bg-color); border-radius: 2px; border: 1px solid var(--border-light);">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <h3 style="font-size: 0.875rem; font-weight: 600; margin: 0;">Filtros</h3>
                        <button id="clearFiltersBtn" class="btn btn-secondary" style="padding: 4px 12px; font-size: 0.75rem;">
                            Limpiar Filtros
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px;">
                        <div>
                            <label style="display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Turno</label>
                            <select id="filterTurno" class="filter-select" style="width: 100%; padding: 6px 10px; font-size: 0.8125rem; border: 1px solid var(--border-color); border-radius: 2px;">
                                <option value="">Todos</option>
                                <option value="Dia">Dia</option>
                                <option value="Noche">Noche</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Condici√≥n</label>
                            <select id="filterCondicion" class="filter-select" style="width: 100%; padding: 6px 10px; font-size: 0.8125rem; border: 1px solid var(--border-color); border-radius: 2px;">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">√Årea</label>
                            <select id="filterArea" class="filter-select" style="width: 100%; padding: 6px 10px; font-size: 0.8125rem; border: 1px solid var(--border-color); border-radius: 2px;">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Ubicaci√≥n</label>
                            <select id="filterUbicacion" class="filter-select" style="width: 100%; padding: 6px 10px; font-size: 0.8125rem; border: 1px solid var(--border-color); border-radius: 2px;">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Desde Fecha</label>
                            <input type="date" id="filterFechaDesde" style="width: 100%; padding: 6px 10px; font-size: 0.8125rem; border: 1px solid var(--border-color); border-radius: 2px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Hasta Fecha</label>
                            <input type="date" id="filterFechaHasta" style="width: 100%; padding: 6px 10px; font-size: 0.8125rem; border: 1px solid var(--border-color); border-radius: 2px;">
                        </div>
                    </div>
                    <div style="margin-top: 12px; font-size: 0.75rem; color: var(--text-secondary);">
                        <span id="filterResultCount">Mostrando todos los pallets</span>
                    </div>
                </div>
                <div class="table-container">
                    <table id="palletsTable">
                        <thead>
                            <tr>
                                <th>Pallet ID</th>
                                <th>Piezas</th>
                                <th>QTY</th>
                                <th>Condici√≥n</th>
                                <th>√Årea</th>
                                <th>Fecha</th>
                                <th>Turno</th>
                                <th>Ubicaci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="palletsTableBody">
                            <!-- Los pallets se cargar√°n aqu√≠ din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                <h2 style="margin: 0;">üìä Dashboard de Control</h2>
                <button onclick="exportDashboardToExcel()" class="btn btn-primary" style="white-space: nowrap;">
                    üì• Exportar Dashboard
                </button>
            </div>
            <div class="stats-grid">
                <div class="stat-card stat-card-highlight">
                    <div class="stat-icon">üîµ</div>
                    <div class="stat-content">
                        <h3 id="palletsEnBin">0</h3>
                        <p>Pallets en BIN</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üè≠</div>
                    <div class="stat-content">
                        <h3 id="palletsWorkcenter">0</h3>
                        <p>Pallets Workcenter</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üì¶</div>
                    <div class="stat-content">
                        <h3 id="totalPallets">0</h3>
                        <p>Total de Pallets</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ö†Ô∏è</div>
                    <div class="stat-content">
                        <h3 id="palletsSinAsignar">0</h3>
                        <p>Pallets Sin Asignar</p>
                    </div>
                </div>
            </div>

            <div class="charts-grid-large">
                <div class="card card-highlight">
                    <h2>üìä Comparativo BIN vs Normal por D√≠a</h2>
                    <canvas id="binVsNormalChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>üìà An√°lisis D√≠a a D√≠a</h2>
                <div class="table-container">
                    <table id="analisisDiaTable">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Pallets Totales</th>
                                <th>Pallets en BIN</th>
                                <th>Pallets Normales</th>
                                <th>Total QTY</th>
                            </tr>
                        </thead>
                        <tbody id="analisisDiaTableBody">
                            <!-- Se cargar√° din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="charts-grid">
                <div class="card">
                    <h2>Pallets por Ubicaci√≥n</h2>
                    <canvas id="ubicacionesChart"></canvas>
                </div>
                <div class="card">
                    <h2>Total de Pallets por D√≠a</h2>
                    <canvas id="palletsPorDiaChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>üìç Pallets por Ubicaci√≥n y D√≠a</h2>
                <div class="table-container">
                    <table id="ubicacionesPorDiaTable">
                        <thead id="ubicacionesPorDiaTableHead">
                            <!-- Se cargar√° din√°micamente -->
                        </thead>
                        <tbody id="ubicacionesPorDiaTableBody">
                            <!-- Se cargar√° din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="charts-grid">
                <div class="card">
                    <h2>Pallets por Condici√≥n</h2>
                    <canvas id="condicionChart"></canvas>
                </div>
                <div class="card">
                    <h2>Pallets por √Årea</h2>
                    <canvas id="areaChart"></canvas>
                </div>
                <div class="card">
                    <h2>Pallets por Turno</h2>
                    <canvas id="turnoChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>Resumen General</h2>
                <div id="resumenGeneral" class="resumen-container">
                    <!-- El resumen se cargar√° aqu√≠ din√°micamente -->
                </div>
            </div>
        </div>

        <!-- Duplicados Tab -->
        <div id="duplicados" class="tab-content">
            <div class="card">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                    <div>
                        <h2 style="margin: 0 0 8px 0;">üîÑ Control de Pallets Duplicados</h2>
                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.875rem;">
                            Pallets con el mismo ID y Fecha registrados m√∫ltiples veces en el sistema
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="exportDuplicadosToExcel()" class="btn btn-secondary" style="white-space: nowrap;">
                            üì• Exportar Excel
                        </button>
                        <button onclick="refreshDuplicados()" class="btn btn-primary" style="white-space: nowrap;">
                            üîÑ Actualizar
                        </button>
                    </div>
                </div>

                <!-- Estad√≠sticas de Duplicados -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-icon">üîÑ</div>
                        <div class="stat-content">
                            <h3 id="totalDuplicados">0</h3>
                            <p>Total Duplicados</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìã</div>
                        <div class="stat-content">
                            <h3 id="palletIdsDuplicados">0</h3>
                            <p>Pallet IDs Afectados</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìÖ</div>
                        <div class="stat-content">
                            <h3 id="fechasDuplicadas">0</h3>
                            <p>Fechas con Duplicados</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìç</div>
                        <div class="stat-content">
                            <h3 id="ubicacionesDuplicadas">0</h3>
                            <p>Ubicaciones Afectadas</p>
                        </div>
                    </div>
                </div>

                <!-- Filtros para Duplicados -->
                <div style="margin-bottom: 20px; padding: 16px; background-color: var(--bg-color); border-radius: 2px; border: 1px solid var(--border-light);">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <h3 style="font-size: 0.875rem; font-weight: 600; margin: 0;">Filtrar Duplicados</h3>
                        <button onclick="clearDuplicadosFilters()" class="btn btn-secondary" style="padding: 4px 12px; font-size: 0.75rem;">
                            Limpiar Filtros
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <div>
                            <label style="display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Pallet ID</label>
                            <input type="text" id="filterDupPalletId" placeholder="Buscar por ID..."
                                   style="width: 100%; padding: 6px 10px; font-size: 0.8125rem; border: 1px solid var(--border-color); border-radius: 2px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Fecha</label>
                            <input type="date" id="filterDupFecha"
                                   style="width: 100%; padding: 6px 10px; font-size: 0.8125rem; border: 1px solid var(--border-color); border-radius: 2px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Ubicaci√≥n</label>
                            <select id="filterDupUbicacion"
                                    style="width: 100%; padding: 6px 10px; font-size: 0.8125rem; border: 1px solid var(--border-color); border-radius: 2px;">
                                <option value="">Todas</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 12px; font-size: 0.75rem; color: var(--text-secondary);">
                        <span id="duplicadosFilterResultCount">Mostrando todos los duplicados</span>
                    </div>
                </div>

                <!-- Tabla de Duplicados Agrupados -->
                <div id="duplicadosContent">
                    <p style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        Cargando duplicados...
                    </p>
                </div>
            </div>

            <!-- Tabla Detallada de Todos los Duplicados -->
            <div class="card">
                <h2>üìä Lista Completa de Registros Duplicados</h2>
                <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 0.875rem;">
                    Todos los registros con PalletID + Fecha duplicados en el sistema
                </p>
                <div class="table-container">
                    <table id="duplicadosDetalleTable">
                        <thead>
                            <tr>
                                <th>Pallet ID</th>
                                <th>Piezas</th>
                                <th>QTY</th>
                                <th>Condici√≥n</th>
                                <th>√Årea</th>
                                <th>Fecha</th>
                                <th>Turno</th>
                                <th>Ubicaci√≥n</th>
                                <th>Grupo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="duplicadosDetalleTableBody">
                            <!-- Los duplicados se cargar√°n aqu√≠ din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Configuraci√≥n Tab -->
        <div id="configuracion" class="tab-content">
            <div class="card">
                <h2>üìÅ Importar/Exportar Datos</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 0.875rem;">
                    Importa pallets desde un archivo Excel o exporta los datos actuales.
                </p>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 20px;">
                    <div style="border: 1px solid var(--border-color); padding: 20px; border-radius: 2px; background-color: var(--surface-elevated);">
                        <h3 style="font-size: 0.9375rem; margin-bottom: 12px; font-weight: 600;">Importar desde Excel</h3>
                        <p style="color: var(--text-secondary); font-size: 0.8125rem; margin-bottom: 16px;">
                            Selecciona un archivo Excel (.xlsx, .xls) con los datos de los pallets.
                        </p>
                        <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;">
                        <button class="btn btn-primary" onclick="document.getElementById('excelFileInput').click()" style="width: 100%;">
                            üì§ Seleccionar Archivo Excel
                        </button>
                        <button class="btn btn-secondary" onclick="downloadExcelTemplate()" style="width: 100%; margin-top: 10px;">
                            üìã Descargar Plantilla
                        </button>
                    </div>

                    <div style="border: 1px solid var(--border-color); padding: 20px; border-radius: 2px; background-color: var(--surface-elevated);">
                        <h3 style="font-size: 0.9375rem; margin-bottom: 12px; font-weight: 600;">Exportar a Excel</h3>
                        <p style="color: var(--text-secondary); font-size: 0.8125rem; margin-bottom: 16px;">
                            Descarga todos los pallets registrados en formato Excel.
                        </p>
                        <button class="btn btn-primary" onclick="exportToExcel()" style="width: 100%;">
                            üì• Exportar Datos
                        </button>
                    </div>
                </div>

                <div id="importPreview" style="display: none; margin-top: 20px; padding: 16px; background-color: #f8f9fa; border: 1px solid var(--border-color); border-radius: 2px;">
                    <h3 style="font-size: 0.9375rem; margin-bottom: 12px; font-weight: 600;">Vista Previa de Importaci√≥n</h3>
                    <div id="importPreviewContent"></div>
                    <div style="display: flex; gap: 10px; margin-top: 16px;">
                        <button class="btn btn-primary" onclick="confirmImport()">Confirmar Importaci√≥n</button>
                        <button class="btn btn-secondary" onclick="cancelImport()">Cancelar</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Gesti√≥n de Ubicaciones</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 0.875rem;">
                    Administra las ubicaciones disponibles para el registro de pallets. Las ubicaciones marcadas como BIN se contabilizar√°n en el dashboard especial.
                </p>

                <form id="ubicacionForm" style="margin-bottom: 30px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nuevaUbicacion">C√≥digo de Ubicaci√≥n *</label>
                            <input type="text" id="nuevaUbicacion" required placeholder="Ej: MTY-MAXX-FFT-AREA04">
                        </div>

                        <div class="form-group">
                            <label for="esUbicacionBin">Tipo de Ubicaci√≥n</label>
                            <select id="esUbicacionBin" required>
                                <option value="false">Ubicaci√≥n Normal</option>
                                <option value="true">Ubicaci√≥n BIN</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Agregar Ubicaci√≥n</button>
                </form>

                <div style="border-top: 1px solid var(--divider); padding-top: 20px;">
                    <h3 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.05em;">
                        Ubicaciones Registradas
                    </h3>

                    <div id="ubicacionesList" class="ubicaciones-list">
                        <!-- Las ubicaciones se cargar√°n aqu√≠ din√°micamente -->
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Informaci√≥n del Sistema</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Versi√≥n:</span>
                        <span class="info-value">1.0.0 Enterprise</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Total de Ubicaciones:</span>
                        <span class="info-value" id="totalUbicaciones">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Ubicaciones BIN:</span>
                        <span class="info-value" id="totalUbicacionesBin">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Ubicaciones Normales:</span>
                        <span class="info-value" id="totalUbicacionesNormales">0</span>
                    </div>
                </div>

                <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color);">
                    <h3 style="font-size: 0.9375rem; margin-bottom: 12px;">Actualizaciones del Sistema</h3>
                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 16px;">
                        Si agregaste nuevos BINs o no ves todas las ubicaciones, actualiza el sistema para cargar los datos m√°s recientes.
                    </p>
                    <a href="reset-ubicaciones.html" style="text-decoration: none;">
                        <button class="btn btn-primary" style="width: 100%;">
                            üîÑ Actualizar BINs y Ubicaciones
                        </button>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Nueva Ubicaci√≥n R√°pida -->
    <div id="quickUbicacionModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Agregar Ubicaci√≥n</h2>
                <span class="close-modal" onclick="closeQuickUbicacionModal()">&times;</span>
            </div>
            <form id="quickUbicacionForm">
                <div class="form-group">
                    <label for="quickNuevaUbicacion">C√≥digo de Ubicaci√≥n *</label>
                    <input type="text" id="quickNuevaUbicacion" required placeholder="Ej: MTY-WAREHOUSE-A1">
                </div>

                <div class="form-group">
                    <label for="quickEsUbicacionBin">Tipo de Ubicaci√≥n</label>
                    <select id="quickEsUbicacionBin" required>
                        <option value="false">Ubicaci√≥n Normal</option>
                        <option value="true">Ubicaci√≥n BIN</option>
                    </select>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeQuickUbicacionModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Agregar y Usar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Edici√≥n -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Pallet</h2>
                <span class="close-modal">&times;</span>
            </div>
            <form id="editPalletForm">
                <input type="hidden" id="editPalletInternalId">

                <div class="form-row">
                    <div class="form-group">
                        <label for="editPalletId">Pallet ID *</label>
                        <input type="text" id="editPalletId" required placeholder="Ej: PLT-001">
                    </div>

                    <div class="form-group">
                        <label for="editPiezas">Piezas *</label>
                        <input type="text" id="editPiezas" required placeholder="Nombre de las piezas">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editCondicion">Condici√≥n *</label>
                        <input type="text" id="editCondicion" required placeholder="Ej: Bueno, Da√±ado, etc.">
                    </div>

                    <div class="form-group">
                        <label for="editArea">√Årea *</label>
                        <input type="text" id="editArea" required placeholder="Ej: Almac√©n, Producci√≥n">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editFecha">Fecha *</label>
                        <input type="date" id="editFecha" required>
                    </div>

                    <div class="form-group">
                        <label for="editTurno">Turno *</label>
                        <select id="editTurno" required>
                            <option value="">Seleccione un turno</option>
                            <option value="Dia">Dia</option>
                            <option value="Noche">Noche</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editUbicacion">Ubicaci√≥n *</label>
                        <select id="editUbicacion" required>
                            <option value="">Seleccione una ubicaci√≥n</option>
                        </select>
                        <button type="button" class="btn-add-ubicacion" onclick="openQuickUbicacionModal()">
                            + Nueva Ubicaci√≥n
                        </button>
                    </div>

                    <div class="form-group">
                        <label for="editQty">QTY *</label>
                        <input type="number" id="editQty" required min="1" placeholder="Cantidad">
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelEdit">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- xlsx-js-style CDN para importar/exportar Excel CON estilos -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style/dist/xlsx.bundle.js"></script>
    <!-- API Configuration and Service -->
    <script src="config.js"></script>
    <script src="api.js"></script>
    <script src="app.js"></script>
    <script src="duplicados_functions.js"></script>
    <script>
        async function doLogout() {
            try {
                await fetch('http://192.168.80.103:8089/api.php?action=logout', {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch(e) {}
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
